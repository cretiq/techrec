# CV Upload Debug Workflow

**🔍 COMPREHENSIVE DEBUG SYSTEM** for Direct Gemini Upload analysis.

## **Environment Setup**
```bash
# Add to .env.local for permanent debugging (recommended):
DEBUG_CV_UPLOAD=true
NODE_ENV=development
ENABLE_DIRECT_GEMINI_UPLOAD=true

# Or set per-command for one-off analysis:
DEBUG_CV_UPLOAD=true NODE_ENV=development [command]
```

## **Test User Configuration**
**🛡️ CRITICAL**: The upload route uses a **real test user** to prevent orphaned CV records:

- **Test User Email**: `cv-upload-test@test.techrec.com`
- **Test User ID**: `689491c6de5f64dd40843cd0`
- **Purpose**: Ensures proper database integrity and foreign key constraints
- **Safety**: Developer existence verified before profile sync operations

**Why This Matters**: Previous mock IDs created orphaned CV records that couldn't sync to profiles, violating database constraints and causing Prisma errors.

## **Debug File Generation**
**Automatic during CV upload** - When debug is enabled, 3 files are created in `/logs/direct-gemini-upload/`:

1. **`[sessionId]-direct-upload.json`** - File upload to Gemini metrics
   - File validation, upload duration, Gemini file URI
   - Local vs Gemini file size comparison
   - Upload success/failure details

2. **`[sessionId]-direct-analysis.json`** - Gemini analysis request/response
   - Full prompt sent to Gemini
   - Model used and configuration
   - Raw response and parsed JSON
   - Data quality metrics (skills count, experience items, etc.)

3. **`[sessionId]-direct-sync.json`** - Profile sync transformation
   - Data transformation from Gemini response to database format
   - Sync success/failure with item counts
   - Database operation performance

## **Debug Analysis Scripts**
**Manual analysis** - Run after CV upload to generate insights:

1. **Direct Upload Analyzer** (Primary):
   ```bash
   DEBUG_CV_UPLOAD=true NODE_ENV=development npx tsx scripts/analyze-direct-upload.ts
   ```
   - Creates `[sessionId]-direct-summary.json` with comprehensive analysis
   - Provides human-readable console output with pipeline health scoring
   - Identifies performance bottlenecks and data quality issues

2. **Universal Flow Analyzer** (Auto-detects method):
   ```bash
   DEBUG_CV_UPLOAD=true NODE_ENV=development npx tsx scripts/analyze-cv-upload-parsing.ts
   ```
   - Detects whether Direct or Traditional upload was used
   - Routes to appropriate analyzer or provides summary for both

## **Debug Output Structure**
```
📁 /logs/direct-gemini-upload/
├── 2025-08-08T13-08-28-590Z-direct-upload.json    # Auto-generated during upload
├── 2025-08-08T13-08-28-590Z-direct-analysis.json  # Auto-generated during upload  
├── 2025-08-08T13-08-28-590Z-direct-sync.json      # Auto-generated during upload
└── 2025-08-08T13-08-28-590Z-direct-summary.json   # Generated by analysis script
```

## **Pipeline Health Analysis**
The debug system provides comprehensive metrics:

- **🚀 Performance**: Upload (1.6s) → Analysis (12.5s) → Sync (1.2s) 
- **📊 Data Quality**: Contact info extraction, skills count, experience parsing
- **✅ Health Score**: 0-100% pipeline health with stage-by-stage breakdown
- **💡 Recommendations**: Specific improvement suggestions for each stage
- **🐛 Issue Detection**: Automatic identification of validation failures, timeouts, parsing errors

## **Common Debug Scenarios**
```bash
# After UI upload, check if debug worked:
ls -la logs/direct-gemini-upload/

# Run analysis to understand pipeline performance:
DEBUG_CV_UPLOAD=true NODE_ENV=development npx tsx scripts/analyze-direct-upload.ts

# Check latest session without running full analysis:
DEBUG_CV_UPLOAD=true NODE_ENV=development npx tsx scripts/analyze-cv-upload-parsing.ts

# Test direct upload via curl (uses real test user):
curl -X POST http://localhost:3000/api/cv/upload \
  -F "file=@tests/fixtures/KRUSHAL_SONANI.pdf" \
  -H "Content-Type: multipart/form-data"
```

## **Expected Success Indicators**
When the debug system is working correctly, you should see:

```bash
# In server logs:
🧪 Test user ID: 689491c6de5f64dd40843cd0
🚀 [DIRECT-GEMINI] Developer verified, proceeding with sync {
  developerId: '689491c6de5f64dd40843cd0',
  email: 'cv-upload-test@test.techrec.com'
}
🚀 [DIRECT-GEMINI] Workflow completed successfully { 
  improvementScore: 100, 
  syncDuration: ~2400ms, 
  finalStatus: 'COMPLETED' 
}

# In curl response:
{"status":"COMPLETED","cvId":"...","improvementScore":100}

# Debug files created:
logs/direct-gemini-upload/
├── [timestamp]-direct-upload.json
├── [timestamp]-direct-analysis.json  
└── [timestamp]-direct-sync.json
```

## **Related Files**
- **Main Upload API**: `app/api/cv/upload/route.ts` - Direct Upload primary
- **Upload Service**: `utils/directGeminiUpload.ts` - Direct Gemini upload service
- **Debug Logger**: `utils/directUploadDebugLogger.ts` - Direct upload debug logging
- **Analysis Scripts**: 
  - `scripts/analyze-direct-upload.ts` - Direct upload analysis
  - `scripts/analyze-cv-upload-parsing.ts` - Universal analyzer
- **Profile Sync**: `utils/backgroundProfileSync.ts` - Profile data synchronization